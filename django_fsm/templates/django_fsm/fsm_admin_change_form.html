{% extends "admin/change_form.html" %}
{% load i18n %}

{% block after_field_sets %}
{{ block.super }}

{% if fsm_object_transitions %}
<fieldset class="module aligned fsm-transitions">
    <h2>{% trans "State Transitions" %}</h2>

    {% for obj_transitions in fsm_object_transitions %}
    <div class="fsm-field-transitions" style="margin-bottom: 20px;">
        {% with current_state=obj_transitions.current_state %}
        {% with field_name=obj_transitions.field_name %}
        <h3 style="margin: 10px 0;">
            {{ field_name|title }}:
            <span class="fsm-current-state" style="font-weight: bold; color: #417690;">
                {{ current_state }}
            </span>
        </h3>
        {% endwith %}
        {% endwith %}

        {% if obj_transitions.transitions %}
        <div class="fsm-transition-buttons" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 0;">
            {% for transition in obj_transitions.transitions %}
            <form method="post" action="{% url 'admin:'|add:opts.app_label|add:'_'|add:opts.model_name|add:'_change' original.pk %}"
                  style="display: inline-block; margin: 0;">
                {% csrf_token %}
                <input type="hidden" name="_fsm_transition" value="{{ transition.name }}">
                <input type="hidden" name="_fsm_field" value="{{ obj_transitions.field_name }}">

                {% if transition.has_form %}
                <button type="button"
                        class="fsm-transition-button"
                        onclick="window.location.href='{% url 'admin:'|add:opts.app_label|add:'_'|add:opts.model_name|add:'_fsm_transition' original.pk %}?transition={{ transition.name }}&field={{ obj_transitions.field_name }}'"
                        style="padding: 8px 16px;
                               background-color: #417690;
                               color: white;
                               border: none;
                               border-radius: 4px;
                               cursor: pointer;
                               font-size: 13px;">
                    {% with label=transition.custom.label %}
                    {% with short_desc=transition.short_description %}
                    {% if label %}
                        {{ label }}
                    {% elif short_desc %}
                        {{ short_desc }}
                    {% else %}
                        {{ transition.name|title }}
                    {% endif %}
                    {% endwith %}
                    {% endwith %}
                    &rarr; {{ transition.target }}
                </button>
                {% else %}
                <button type="submit"
                        class="fsm-transition-button"
                        style="padding: 8px 16px;
                               background-color: #417690;
                               color: white;
                               border: none;
                               border-radius: 4px;
                               cursor: pointer;
                               font-size: 13px;"
                        onclick="return confirm('{% blocktrans with name=transition.name %}Are you sure you want to perform the transition: {{ name }}?{% endblocktrans %}');">
                    {% with label=transition.custom.label %}
                    {% with short_desc=transition.short_description %}
                    {% if label %}
                        {{ label }}
                    {% elif short_desc %}
                        {{ short_desc }}
                    {% else %}
                        {{ transition.name|title }}
                    {% endif %}
                    {% endwith %}
                    {% endwith %}
                    &rarr; {{ transition.target }}
                </button>
                {% endif %}
            </form>
            {% endfor %}
        </div>
        {% else %}
        <p class="fsm-no-transitions" style="color: #666; font-style: italic; padding: 10px 0;">
            {% trans "No transitions available from this state." %}
        </p>
        {% endif %}
    </div>
    {% endfor %}
</fieldset>
{% endif %}
{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.fsm-transition-button:hover {
    background-color: #205067 !important;
}
.fsm-transition-button:active {
    transform: translateY(1px);
}
</style>
{% endblock %}
